# 任务拆分与待办清单（Backlog）

按模块/能力拆分任务，标注优先级与验收标准，支持并行开发。

## M0 初始化

- T0-1 仓库骨架与质量基线
  - 内容：初始化 Cargo 项目、添加 .gitignore、确保 clippy 通过。
  - 验收：cargo fmt、cargo clippy -- -D warnings 通过。

- T0-2 文档编写
  - 内容：ARCHITECTURE、DEVELOPMENT_PLAN、TASKS。
  - 验收：docs/* 完整清晰，README 指向文档。

## M1 MVP 基础代理

- T1-1 路由与入口
  - 内容：使用 worker-rs 建立 Worker 入口与路由（如 /v1/* 透传）。
  - 验收：本地/Miniflare 能启动并响应 200（回环或上游 mock）。

- T1-2 配置加载
  - 内容：定义 Config 结构，从环境变量/Secrets 读取 Provider、Keys、策略等。
  - 验收：无效配置报错；有效配置能在日志中打印关键信息（脱敏）。

- T1-3 Key 池与轮询 LB
  - 内容：实现 KeyPool；RR 选择策略；429/5xx 标记 Key 暂不可用。
  - 验收：在集成测试中能观察到 Key 轮换与故障切换。

- T1-4 上游客户端（单 Provider）
  - 内容：实现 Provider trait 的第一个适配器（OpenAI 或 Anthropic）。
  - 验收：成功转发非流式请求，返回上游响应体与状态码。

- T1-5 基础日志与错误处理
  - 内容：结构化日志（请求 ID、耗时、上游），错误分类与映射。
  - 验收：日志可读，错误码与信息合理。

## M2 稳定性增强

- T2-1 重试与超时
  - 内容：指数退避 + 抖动；可配置超时；最大重试次数。
  - 验收：在模拟 429/5xx 下重试次数与延迟符合预期。

- T2-2 健康探针
  - 内容：/healthz、/readyz；可输出关键依赖检查结果。
  - 验收：部署后可被监控系统探测。

- T2-3 结构化日志与追踪
  - 内容：统一日志格式；可选 Trace ID 透传；关键指标打点。
  - 验收：日志与指标能在 Analytics/日志系统中聚合分析。

## M3 Streaming 与多 Provider

- T3-1 SSE 转发
  - 内容：端到端流式转发；对中断/错误的降级策略。
  - 验收：流式客户端（如 curl -N）能收到稳定事件流。

- T3-2 Provider 抽象与第二适配器
  - 内容：定义 Provider trait；新增第二个 Provider（与 M1 不同）。
  - 验收：按路由或配置选择不同 Provider；回归测试通过。

## M4 配置与管理

- T4-1 统一配置结构
  - 内容：集中管理配置项（Keys、策略、Provider、超时等）。
  - 验收：配置变更无需改代码；启动日志打印生效配置（脱敏）。

- T4-2 管理 API（受保护）
  - 内容：查询 Key 状态、切换策略、手动熔断/恢复。
  - 验收：鉴权通过后可执行；审计日志完整。

- T4-3 动态配置（可选）
  - 内容：从 KV/DO 拉取并定期刷新配置。
  - 验收：变更后可在不中断情况下生效。

## M5 速率与并发控制

- T5-1 并发限制
  - 内容：全局/Key 级 in-flight 计数与阈值；最少并发策略。
  - 验收：压测下队列/丢弃策略符合预期。

- T5-2 限流器
  - 内容：简单令牌桶；每 Key QPS 限制；突发控制。
  - 验收：在压测中平滑限制 QPS。

## M6 监控与告警

- T6-1 指标与可视化
  - 内容：Workers Analytics Engine 指标上报与仪表盘。
  - 验收：核心指标（QPS、错误率、P95）可视化。

- T6-2 告警阈值
  - 内容：定义并实现告警（如错误率突增、Key 不可用）。
  - 验收：演练触发后能收到告警。

---

## 通用开发规范
- 错误处理：Result + thiserror；使用 ? 传播，按层次映射。
- 异步：async/await；避免阻塞。
- 日志：结构化，注意脱敏；禁止打印完整密钥。
- 测试：单元、集成、端到端（Miniflare）；必要时提供上游 mock。
- 安全：CORS、鉴权、Secrets 管理（wrangler secret）。
